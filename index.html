<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Reservasi Dolan Sawah (Firebase) - V5.3 With Price</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h2><i class="fas fa-leaf"></i> Sistem Reservasi Dolan Sawah</h2>
    <small>Versi 5.3 (Perbaikan Stabilitas & Data Harga)</small>

    <div id="notification-bell-container" onclick="toggleNotificationDropdown(event)">
      <i class="fas fa-bell"></i>
      <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
      <div id="notification-dropdown" class="notification-list-dropdown">
        <h4><i class="fas fa-bell"></i> Pengingat Ucapan Terima Kasih</h4>
        <ul id="notification-list-ul"></ul>
      </div>
    </div>
  </header>
  
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
  <div class="toast" id="toast"></div>
  
  <div id="login-container">
    <h3><i class="fas fa-lock"></i> Login Admin</h3>
    <label>Email: <input type="email" id="loginEmail" placeholder="Masukkan email admin"/></label>
    <label>Password: <input type="password" id="loginPassword" placeholder="Masukkan password"/></label>
    <button onclick="handleLogin()"><i class="fas fa-sign-in-alt"></i> Login</button>
    <p id="login-error">Email atau password salah.</p>
  </div>
  
  <button id="logout-button" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  
  <div class="container" id="main-container">
    <div class="calendar-header">
      <div class="month-year" id="monthYear"></div>
      <div class="calendar-nav">
        <button onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
        <button class="secondary" onclick="goToToday()"><i class="fas fa-calendar-day"></i> Hari Ini</button>
        <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
    
    <div class="calendar-weekdays"><div>Min</div> <div>Sen</div> <div>Sel</div> <div>Rab</div> <div>Kam</div> <div>Jum</div> <div>Sab</div></div>
    <div class="calendar-days" id="calendar"></div>
        
    <div class="action-buttons">
      <button onclick="showCustomerMenu()"><i class="fas fa-address-book"></i> Customer</button>
      <button onclick="showMenuManagement()"><i class="fas fa-book-open"></i> Kelola Menu</button>
      <button onclick="showLocationManagement()"><i class="fas fa-map-marker-alt"></i> Kelola Tempat</button>
      <button class="info" onclick="showAnalysis()"><i class="fas fa-chart-pie"></i> Analisis Data</button>
      <div class="whatsapp-options-container">
        <button class="whatsapp" onclick="toggleWhatsAppOptions(event)"><i class="fab fa-whatsapp"></i> Bagikan WhatsApp</button>
        <div class="whatsapp-options" id="whatsappOptions">
          <p>Pilih Opsi Laporan Bulanan:</p>
          <button class="whatsapp" onclick="shareViaWhatsApp('month')">Kirim Rekap 1 Bulan</button>
        </div>
      </div>
      <button class="info" onclick="showExportDataPopup()"><i class="fas fa-file-export"></i> Export Data ASCII</button>
      <button class="secondary" onclick="showBroadcastMain()"><i class="fas fa-bullhorn"></i> Broadcast Promo</button>
      <button class="accent" onclick="forceSync()"><i class="fas fa-sync-alt"></i> Sinkronisasi</button>
    </div>

  </div>

  <div id="addFormPopup" class="popup-form">
    <h3><i class="fas fa-calendar-plus"></i> Input Reservasi</h3>
    <form id="reservation-form">
      <label>Nama: <input type="text" id="nama" required /><span class="error-message" id="nama-error"></span></label>
      <label>Nomor HP: <input type="tel" id="nomorHp" placeholder="Cth: 081234567890" /><span class="error-message" id="nomorHp-error"></span></label>
      <label>Jam Reservasi: <input type="time" id="jam" required /><span class="error-message" id="jam-error"></span></label>
      <label>Jumlah Peserta: <input type="number" id="jumlah" min="1" required /><span class="error-message" id="jumlah-error"></span></label>
      
      <label>DP (Rupiah): <input type="number" id="dp" value="0" min="0" /></label>
      <label>Tipe Pembayaran DP: 
        <select id="tipeDp">
          <option value="">- Tanpa DP -</option><option>Cash</option><option>QRIS</option><option>Transfer BCA</option><option>Transfer Mandiri</option><option>Transfer BRI</option>
        </select>
      </label>
      
      <label>Tempat: <select id="tempat" required onchange="updateCapacityInfo('reservation-form')"></select>
        <span id="capacity-info"></span>
        <span class="error-message" id="tempat-error"></span>
      </label>
      
      <label>Paket Menu Dipesan: <span class="error-message" id="menus-error"></span></label>
      <div id="selected-menus-container"></div>
      <button type="button" class="secondary" id="add-menu-btn" onclick="addMenuSelectionRow('reservation-form')"><i class="fas fa-plus"></i> Tambah Paket</button>

      <label>Request Tambahan: <textarea id="tambahan"></textarea></label>
      <div class="data-actions">
        <button type="button" onclick="simpanReservasi()"><i class="fas fa-save"></i> Simpan Reservasi</button>
        <button type="button" class="danger" onclick="closePopup('addFormPopup')"><i class="fas fa-times"></i> Batal</button>
      </div>
    </form>
  </div>

  <div id="editFormPopup" class="popup-form"></div>
  <div id="menuManagementPopup" class="popup-form"></div>
  <div id="locationManagementPopup" class="popup-form"></div>
  <div id="customerListPopup" class="popup-form"></div>
  <div id="analysisPopup" class="popup-form"></div>
  
  <div id="exportDataPopup" class="popup-form">
    <h3><i class="fas fa-file-export"></i> Export Data ASCII untuk Viewer</h3>
    <p>Salin kode di bawah ini dan tempelkan ke dalam kolom import di website kalender viewer.</p>
    <textarea id="export-data-output" readonly style="height: 150px; font-family: monospace; font-size: 0.8rem; background-color: #f0f0f0; resize: vertical;"></textarea>
    <div class="data-actions">
        <button type="button" onclick="copyExportCode()"><i class="fas fa-copy"></i> Salin Kode</button>
        <button type="button" class="danger" onclick="closePopup('exportDataPopup')"><i class="fas fa-times"></i> Tutup</button>
    </div>
  </div>

  <div id="printOptionsPopup" class="popup-form">
    <h3><i class="fas fa-print"></i> Opsi Cetak</h3>
    <p>Pilih detail yang ingin Anda sertakan dalam hasil cetak:</p>
    <div id="print-options-form">
        <div class="print-options-grid">
            <label><input type="checkbox" id="print-detail-menu" checked> Detail Menu</label>
            <label><input type="checkbox" id="print-kontak" checked> Kontak (No. HP)</label>
            <label><input type="checkbox" id="print-dp" checked> Info DP</label>
            <label><input type="checkbox" id="print-tambahan" checked> Request Tambahan</label>
        </div>
        <div class="data-actions">
            <button type="button" onclick="executePrint()"><i class="fas fa-check"></i> Lanjutkan Cetak</button>
            <button type="button" class="danger" onclick="closePopup('printOptionsPopup')"><i class="fas fa-times"></i> Batal</button>
        </div>
    </div>
  </div>
  
  <div class="overlay" id="overlay"></div>

  <div id="broadcastMainPopup" class="popup-form">
    <h3><i class="fas fa-bullhorn"></i> Menu Broadcast Promo</h3>
    <p>Gunakan fitur ini untuk mengirimkan promosi atau pengumuman ke semua pelanggan yang pernah reservasi.</p>
    <div class="data-actions" style="margin-top: 20px;">
        <button type="button" class="info" onclick="showBroadcastSettings()"><i class="fas fa-cog"></i> Atur Pesan Broadcast</button>
        <button type="button" class="whatsapp" onclick="showBroadcastList()"><i class="fas fa-paper-plane"></i> Mulai Broadcast</button>
    </div>
    <div class="data-actions" style="margin-top: 10px;">
        <button type="button" class="danger" onclick="closePopup('broadcastMainPopup')"><i class="fas fa-times"></i> Tutup</button>
    </div>
  </div>

  <div id="broadcastSettingsPopup" class="popup-form">
    <h3><i class="fas fa-cog"></i> Atur Pesan Broadcast</h3>
    <p>Tulis pesan yang ingin Anda kirimkan. Anda bisa menggunakan *teks tebal* atau _miring_ untuk format WhatsApp.</p>
    <form id="broadcast-settings-form">
        <label for="broadcastMessage">Pesan Promo:</label>
        <textarea id="broadcastMessage" placeholder="Contoh: Halo Kak! Ada promo spesial weekend ini di Dolan Sawah..." style="height: 150px;"></textarea>
        <div class="data-actions" style="margin-top: 20px;">
            <button type="button" onclick="saveBroadcastMessage()"><i class="fas fa-save"></i> Simpan Pesan</button>
            <button type="button" class="secondary" onclick="closePopup('broadcastSettingsPopup'); showBroadcastMain()"><i class="fas fa-arrow-left"></i> Kembali</button>
        </div>
    </form>
  </div>
  <div id="broadcastListPopup" class="popup-form" style="max-width: 700px;">
    <h3><i class="fas fa-users"></i> Daftar Penerima Broadcast</h3>
    <p>Klik tombol "Broadcast" untuk mengirim pesan ke masing-masing customer via WhatsApp.</p>
    <div class="search-container" style="margin-top: 15px;">
        <i class="fas fa-search"></i>
        <input type="text" id="broadcastCustomerSearch" oninput="filterBroadcastCustomers(this.value)" placeholder="Cari nama atau nomor HP...">
    </div>
    <div id="broadcast-customer-list" style="max-height: 40vh; overflow-y: auto; margin-top: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0;">
        <p style="text-align: center; color: #888;">Memuat daftar customer...</p>
    </div>
    <div class="data-actions" style="margin-top: 20px;">
        <button type="button" class="danger" onclick="closePopup('broadcastListPopup')"><i class="fas fa-times"></i> Tutup</button>
    </div>
  </div>

  <div id="reservation-view-container" style="display: none; background-color: #f5f5f5; padding: 20px;">
    <div class="reservation-view-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--primary);">
        <h2 id="reservation-view-title" style="color: var(--primary-dark); font-size: 1.8rem;"></h2>
        <div class="header-actions">
            <button onclick="showAddForm()"><i class="fas fa-plus"></i> Tambah Reservasi</button>
            <button class="whatsapp" onclick="shareViaWhatsApp('day')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
            <button class="secondary" onclick="shareViaEmail()"><i class="fas fa-envelope"></i> Email</button>
            <div class="sort-options-container" style="width: auto; position: relative;">
                <button class="secondary" onclick="toggleDetailSort(event)"><i class="fas fa-sort"></i> Urutkan</button>
                <div class="sort-options" id="sortOptionsDetail" style="bottom: auto; top: 100%; margin-top: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <p>Urutkan berdasarkan:</p>
                    <button onclick="sortReservations('jam')">Jam</button>
                    <button onclick="sortReservations('tempat')">Tempat</button>
                </div>
            </div>
            <button onclick="printData()"><i class="fas fa-print"></i> Print</button>
            <button class="danger" onclick="kembaliKeKalender()"><i class="fas fa-arrow-left"></i> Kembali</button>
        </div>
    </div>
    
    <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="detailSearchInput" oninput="filterReservations(this.value)" placeholder="Cari nama, tempat, atau menu...">
    </div>

    <div id="reservation-detail-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px;">
    </div>
  </div>
  
  <footer><p><i class="fas fa-code"></i> Dibuat oleh Ryan </p></footer>

  <script src="app.js"></script>
</body>
</html>
